# 1. تحديث Ubuntu وتثبيت أدوات أساسية:

sudo apt update && sudo apt upgrade -y
sudo apt install git curl wget -y
sudo reboot

# 2. تثبيت ROS Noetic:

sudo sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'
curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -
sudo apt update
sudo apt install ros-noetic-desktop-full python3-rosinstall python3-rosinstall-generator python3-wstool build-essential -y
sudo rosdep init
rosdep update
echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
source ~/.bashrc

#3. تثبيت PX4

mkdir -p ~/PX4-Autopilot
cd ~/PX4-Autopilot
git clone https://github.com/PX4/PX4-Autopilot.git --recursive .
bash ./Tools/setup/ubuntu.sh
sudo reboot

# 4. إنشاء Workspace وتثبيت MAVROS + Dependencies:

mkdir -p ~/Abdelfattah_ws/src
cd ~/Abdelfattah_ws
catkin init
wstool init src
cd src
rosinstall_generator --rosdistro noetic mavlink | tee /tmp/mavros.rosinstall
rosinstall_generator --upstream mavros --deps | tee -a /tmp/mavros.rosinstall
wstool merge -t . /tmp/mavros.rosinstall
wstool update -t . -j4
cd ~/Abdelfattah_ws
sudo apt install ros-noetic-mavlink ros-noetic-uuid-msgs ros-noetic-geographic-msgs ros-noetic-sensor-msgs -y
sudo ./src/mavros/mavros/scripts/install_geographiclib_datasets.sh
catkin build
source devel/setup.bash
echo "source ~/Abdelfattah_ws/devel/setup.bash" >> ~/.bashrc
source ~/.bashrc

# 5. تشغيل Simulation مع LiDAR:

# Terminal 1: ROS Master
roscore

# Terminal 2: PX4 SITL مع LiDAR
source /opt/ros/noetic/setup.bash
source ~/Abdelfattah_ws/devel/setup.bash
cd ~/PX4-Autopilot
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$(pwd):$(pwd)/Tools/simulation/gazebo-classic/sitl_gazebo-classic
source Tools/simulation/gazebo-classic/setup_gazebo.bash $(pwd) $(pwd)/build/px4_sitl_default
make px4_sitl gazebo-classic_iris_opt_flow

# Terminal 3: Gazebo World
source /opt/ros/noetic/setup.bash
source ~/Abdelfattah_ws/devel/setup.bash
roslaunch gazebo_ros empty_world.launch world_name:=~/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic/worlds/empty.world

# Terminal 4: Spawn Drone
source /opt/ros/noetic/setup.bash
source ~/Abdelfattah_ws/devel/setup.bash
rosrun gazebo_ros spawn_model -sdf -file ~/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic/models/iris_opt_flow/iris_opt_flow.sdf -model iris_opt_flow -x 0 -y 0 -z 0.5 -R 0 -P 0 -Y 0

# Terminal 5: MAVROS
source /opt/ros/noetic/setup.bash
source ~/Abdelfattah_ws/devel/setup.bash
roslaunch mavros px4.launch fcu_url:="udp://:14540@127.0.0.1:14557"
